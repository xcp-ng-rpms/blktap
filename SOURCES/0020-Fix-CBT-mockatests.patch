From b32799564c85dd38275ff17f9b8cdbfd47e5ad29 Mon Sep 17 00:00:00 2001
From: Mark Syms <mark.syms@cloud.com>
Date: Tue, 26 Nov 2024 11:29:47 +0000
Subject: [PATCH 20/30] Fix CBT mockatests

Signed-off-by: Mark Syms <mark.syms@cloud.com>
---
 cbt/cbt-util.c                          | 2 +-
 mockatests/cbt/test-cbt-util-coalesce.c | 6 +++---
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/cbt/cbt-util.c b/cbt/cbt-util.c
index e210b900..cb05a758 100644
--- a/cbt/cbt-util.c
+++ b/cbt/cbt-util.c
@@ -105,7 +105,7 @@ read_cbt_metadata(char *name, FILE *f, struct cbt_log_metadata *log_meta)
 	ret = fread(log_meta, sizeof(struct cbt_log_metadata), 1, f);
 
 	if (!ret) {
-		fprintf(stderr, "Failed to read CBT metadata from file %s\n", name);
+		fprintf(stderr, "Failed to read CBT metadata from file %s, error %s\n", name, strerror(ferror(f)));
 		err = -EIO;
 	}
 
diff --git a/mockatests/cbt/test-cbt-util-coalesce.c b/mockatests/cbt/test-cbt-util-coalesce.c
index 6691ea0b..6ac9e340 100644
--- a/mockatests/cbt/test-cbt-util-coalesce.c
+++ b/mockatests/cbt/test-cbt-util-coalesce.c
@@ -442,19 +442,19 @@ void test_cbt_util_coalesce_set_file_pointer_failure(void **state)
 	((struct cbt_log_metadata*)parent_data)->size = size;
 	//Fill bitmap with random bytes
 	memcpy(parent_data + sizeof(struct cbt_log_metadata), (void*)memcpy, bmsize );
-	FILE *parent_log = fmemopen((void*)parent_data, file_size, "w+");
+	FILE *parent_log = fmemopen((void*)parent_data, file_size, "r");
 
 	//Intialise size in metadata file
 	((struct cbt_log_metadata*)child_data)->size = size;
 	//Fill bitmap with random bytes
 	memcpy(child_data + sizeof(struct cbt_log_metadata), (void*)memcpy, bmsize );
-	FILE *child_log = fmemopen((void*)child_data, file_size, "w+");
+	FILE *child_log = fmemopen((void*)child_data, file_size, "r+");
 
 	will_return(__wrap_fopen, parent_log);
 	expect_value(__wrap_fclose, fp, parent_log);
 	will_return(__wrap_fopen, child_log);
 	expect_value(__wrap_fclose, fp, child_log);
-	
+
 	fail_fseek(EIO);
 
 	result = cbt_util_coalesce(6, args);
